---
title: "Route Prediction"
author: "Belle Schmidt"
date: "2024-11-19"
output: html_document
---

# Set Up ---------------------

```{r}
# reading in the packages necessary
library(nflverse)
library(nflreadr)
library(nflplotR)
library(ggplot2)
library(tidyverse)
library(gganimate)
library(dplyr)
library(gganimate)
library(ggfootball)
```

```{r}
# gives me more information about the nflreadr package
library(help = "nflreadr")
```

```{r}
# reading in dataset
games <- read.csv("games.csv")
player_play <- read.csv("player_play.csv")
players <- read.csv("players.csv")
plays <- read.csv("plays.csv")
```

```{r}
# reading in week by week tracking data
tracking_week1 <- read.csv("tracking_week_1.csv")
tracking_week2 <- read.csv("tracking_week_2.csv")
tracking_week3 <- read.csv("tracking_week_3.csv")
tracking_week4 <- read.csv("tracking_week_4.csv")
tracking_week5 <- read.csv("tracking_week_5.csv")
tracking_week6 <- read.csv("tracking_week_6.csv")
tracking_week7 <- read.csv("tracking_week_7.csv")
tracking_week8 <- read.csv("tracking_week_9.csv")
```

# Determining What Plays To Include in Route Running Predicition ------------------

# Setting up the data for more exploration
```{r}
# add play information to individual player play by play data
player_play_w_info <- player_play |> 
  inner_join(plays, join_by(gameId, playId))

# identify all players (by nflID) that play WR 
WR <- players |> 
  filter(position == "WR") |> 
  distinct(nflId)
```

# Finding out which positions other than WR & TE are running routes 
```{r}
# identify all players that ran at least one route 
route_runners <- player_play |> 
  drop_na(routeRan) |> 
  distinct(nflId)

# identify which players were not WR that ran a route 
Non_WR_route_runners <- anti_join(route_runners, WR)
  
# identify which positions ran routes that were not WR and how often - notice there are QB, FB, TE, and RB as well
left_join(Non_WR_route_runners, players) |> 
  count(position)

# find out how many players play each position
players |> 
  count(position)
```

# Decided to focus on only WR 
```{r}
# Players WR Positions - Include only position of each player, their name, and their NFLId
positions <- players |> 
  filter(position == "WR") |> 
  select(nflId, displayName, position)

# All play information of WRs that ran at least one route - there are 40,940
plays_of_route_runners <- inner_join(player_play_w_info, positions)
```

# Finding the distribution of the routes ran - it is a little worrisome that so many routes are NAs. There is also a very large disproportion each route is run
```{r}
# The number of times and the proportion of the time each route is run by WR or TEs 
plays_of_route_runners |> 
  group_by(routeRan) |> 
  summarise(occurances = n()) |> 
  mutate(prop = occurances / sum(occurances)) 
```

# Figuring out what some of the NAs could mean -------------------
```{r}
# Plays where at least one receiver or tight end did not run a route - there are 6,874 plays
no_route_ran <- plays_of_route_runners |> 
  filter(is.na(routeRan)) |> 
  distinct(gameId, playId)

no_route_ran
```

```{r}
# Plays where the ball is spiked or the QB kneels - there are 188
deadplays <- plays |> 
  filter(is.na(offenseFormation))

deadplays
```

```{r}
# removes kneeling and spike plays - now there are 6,690 plays
no_route_ran <- anti_join(no_route_ran, deadplays)

no_route_ran

# removes kneeling and spike plays from WR play by play info - there are now 40,690 observations

plays_of_route_runners <- anti_join(plays_of_route_runners, deadplays, join_by(gameId, playId))

plays_of_route_runners

# remove QB sneaks from the data. This is okay to remove because QB sneaks are very predictable plays so the defense already knows the receiver isn't running a route. - There are still 40,438 reciever plays
plays_of_route_runners <- plays_of_route_runners |> 
  filter(is.na(qbSneak) | qbSneak == FALSE)

# Creating a list of plays where qb sneaks are not included
valid_plays <- plays_of_route_runners |> 
  distinct(gameId, playId)


# Remove QB sneaks from the list of plays where at least one WR with an NA route - 6,571 plays
no_route_ran <- no_route_ran|> 
  inner_join(valid_plays)

no_route_ran

```

```{r}
# See how many plays now have NAs for routes ran - 15,393
plays_of_route_runners |> 
  filter(is.na(routeRan))

# There are no plays that were blown dead because of penalty
plays_of_route_runners |> 
  count(playNullifiedByPenalty)
```

# Replacing NAs with saying no route ran - do we want to change this so people who blocked someone it says block. And the rest say NO ROUTE?
```{r}
plays_of_route_runners <- plays_of_route_runners |> 
  mutate(routeRan = replace_na(routeRan, "NO ROUTE"))
```


# Exploratory Data Analysis ----------------------

## Distribution of Variables ---------------------

### Routes Ran

```{r}
# The number of times and the proportion of the time each route is run by WR
plays_of_route_runners |> 
  group_by(routeRan) |> 
  summarise(occurances = n()) |> 
  mutate(prop = occurances / sum(occurances)) 
```


```{r, fig.cap= "There is a very large disproportion of the number of times each route is ran. Specifically a lot of the time receivers ran no route."}
# Distribution of routes ran

plays_of_route_runners |> 
  ggplot(aes(x = fct_rev(fct_infreq(routeRan)), fill = routeRan)) +
  geom_bar() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8.5), legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 14), axis.title = element_text(face = "bold", size = 12), axis.text = element_text(face = "bold")) +
  labs(
    title = "Distribution of Routes Ran By Wide Recievers",
    x = "Route Ran",
    y = "Number of Times That Route Was Ran"
  )
```

# Defining the Different Routes ------------
**Wheel:** When the reciever runs kind of an L shaped path. Out and then down field - most commonly run by RB

**Angle:** when the player cuts out 45 degrees and then takes a 90 degree turn and cuts back in (often RB, FB, or TE) - makes sense why few WR run it

**Screen:** Various types. More of a basic screen is where RB catches ball and lineman block. Then Jailbreak screen is where the receiver out wide is the target. Two receivers and a lineman are blockers. Bubble screen is where WR drops back slightly and two recievers block. Drop back screen looks like drop back pass but one WR runs route and other WR block. Could be TE too? 

**Flat:** when the receiver runs a quick short route straight then towards the sideline

**Corner:** when the receiver runs down the field and then turns outward 45degrees (opposite direction of post)

**Slant:** when the receiver runs shortly straight and then turns inward 45 degrees (like short version of post)

**Post:** when the receiver runs 10 to 20 yards down field and then turns 45 degrees and runs towards the goal posts 

**Out:** when the receiver runs down the field and then cuts out and runs parallel to the line of scrimmage

**In:** when the receiver runs down the field and then cuts in and runs parallel to the line of scrimmage

**Cross:** when the receiver crosses across the field

**Hitch:** when the receiver runs a set number of yards (normally 5 to 6) and then turns to face the QB 

**Go:** When the wide receiver runs straight down field as fast as they can

### Formations 

```{r}
# The number of times and the proportion of the time each formation is used
plays_of_route_runners |> 
  group_by(offenseFormation) |> 
  summarise(occurances = n()) |> 
  mutate(prop = occurances / sum(occurances)) 
```


```{r}
# Distribution of Formations 

plays_of_route_runners |> 
  ggplot(aes(x = fct_rev(fct_infreq(offenseFormation)), fill = offenseFormation)) +
  geom_bar() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8.5), legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 14), axis.title = element_text(face = "bold", size = 12), axis.text = element_text(face = "bold")) +
  labs(
    title = "Distribution of Formation Usage",
    x = "Formation",
    y = "Number of Times That Formation Was Used"
  )
```

**Shotgun:** When the quarterback is several yards back from the center and has more time to read the defense. In this case, when the ball is snapped, the quarterback is not grabbing it directly from the center.

**Single back:** When the quarterback is under center (grabs the ball directly from the center) and there is a single RB about 5 yards back

**Empty:** When there are no backs in the backfield so the quarterback is the only player in the backfield

**Pistol:** When the quarterback is a couple yards behind the center (closer than for shotgun though) and there is a running back right behind him

**Wildcat:** when the ball is snapped to a position player other than the QB... might want to remove these

**Jumbo:** when an offensive lineup is designed for maximum blocking power (often close to goal line). Normally sub a receiver for an extra TE.

#### Exploring Jumbo ------------------------------
```{r}

# filtering for plays where the formation was Jumbo
jumbo <- plays_of_route_runners |> 
  filter(offenseFormation == "JUMBO"
         ) |> 
  distinct(gameId, playId)

jumbo

# answered questions like - (1) are plays with off formation jumbo always runs (no) (2) how often in the jumbo formation do recievers run routes (3) how often do receivers block on jumbo plays
plays_of_route_runners |> 
  inner_join(jumbo) |> 
  filter(!is.na(passLength)) |> 
  #filter(routeRan != "NO ROUTE") |> 
  #filter(is.na(blockedPlayerNFLId1)) |> 
  #count(gameId, playId) |> 
  #count(n)

```

#### Exploring Wildcat ------------------------------
```{r}

# filtering for plays where the formation was Jumbo
wildcat <- plays_of_route_runners |> 
  filter(offenseFormation == "WILDCAT"
         ) |> 
  distinct(gameId, playId)

wildcat

# how many WR do not run routes when in the wildcat formation - since most don't & this is a really unique play, maybe we remove it? 
plays_of_route_runners |> 
  inner_join(wildcat) |> 
  filter(routeRan == "NO ROUTE") |> 
  count(gameId, playId) |> 
  count(n)

```

### Receiver Alignment

```{r}
# The number of times and the proportion of the time each receiver alignment is used
plays_of_route_runners |> 
  group_by(receiverAlignment) |> 
  summarise(occurances = n()) |> 
  mutate(prop = occurances / sum(occurances)) 
```

```{r}
# Distribution of Receiver Alignment 

plays_of_route_runners |> 
  ggplot(aes(x = fct_rev(fct_infreq(receiverAlignment)), fill = receiverAlignment)) +
  geom_bar() +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8.5), legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 14), axis.title = element_text(face = "bold", size = 12), axis.text = element_text(face = "bold")) +
  labs(
    title = "Distribution of Receiver Alignment Usage",
    x = "Receiver Alignment",
    y = "Number of Times That Receiver Alignment Was Used"
  )
```

### Motion

```{r}
# Making motion easier to work with
motion <- plays_of_route_runners |> 
  mutate(inMotionAtBallSnap = ifelse(inMotionAtBallSnap == TRUE, 1, 0),
         inMotionAtBallSnap = replace_na(inMotionAtBallSnap, 0))

# the proportion of the time each player motions
player_prop_motion <- motion|> 
  group_by(displayName) |> 
  summarise(propInMotion = round(mean(inMotionAtBallSnap), 3)) |> 
  arrange(propInMotion)

player_prop_motion


# proportion of the time that each team motions
team_prop_motion <- motion|> 
  group_by(possessionTeam) |> 
  summarise(propInMotion = round(mean(inMotionAtBallSnap), 3)) |> 
  arrange(propInMotion)

team_prop_motion
```

```{r, fig.cap="The distribution is relatively even. MIA motions A LOT though. PHI and NE seem to motion less.}
# Distribution of Receiver Alignment - fix this so each team is represented by their team colors

team_prop_motion |> 
  ggplot(aes(x = possessionTeam, y = propInMotion, fill = possessionTeam)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(size = 8.5, angle = 90), legend.position = "none", plot.title = element_text(hjust = 0.5, face = "bold", size = 14), axis.title = element_text(face = "bold", size = 12), axis.text = element_text(face = "bold")) +
  labs(
    title = "Proportion of Plays Each NFL Team Motions",
    x = "NFL Team",
    y = "Proportion of Plays Motioned"
  )
```

# Work That Will Not Be Used ---------------------------------------------------------

# Figuring Out When They Might Be Blocking ----------------------
```{r}
# All plays where the WR blocked a player- on 11 of them the WR still ran a route
plays_of_route_runners |> 
  filter(!is.na(blockedPlayerNFLId1))


### Finding out what happened when blocker ran corner route ----------------

# identifying the play where the blocker ran a corner route
corner_blocker <- plays_of_route_runners |> 
  filter(!is.na(blockedPlayerNFLId1),
         routeRan == "CORNER"
         ) |> 
  distinct(gameId, playId)

# find out what is happening on the play where he ran a corner route and blocked - how can he block, run a corner route and have the ball passed to him ? 
plays_of_route_runners |> 
  inner_join(corner_blocker)

# seeing all TE and WR involved in the play
player_play_w_info |> 
  inner_join(corner_blocker) |> 
  inner_join(players, join_by(nflId))|> 
  filter(position %in% c("TE", "WR")) |> 
  select(gameId, playId, displayName, blockedPlayerNFLId1)
```

```{r}
# Find out which plays have at least one WR that ran a route and one WR that did not run a route - makes sense thatscreen is one of the highest 
plays_of_route_runners |> 
  inner_join(no_route_ran) |> 
  drop_na(routeRan) |> 
  count(routeRan)
  
```

```{r}
plays_of_route_runners |> 
  count(routeRan)
  
  drop_na(routeRan) |> 
  count(gameId, playId, routeRan) |> 
  filter(routeRan == "JUMBO") |> 
  count(n)


screen_plays <- plays_of_route_runners |> 
  filter(routeRan == "SCREEN") |> 
  distinct(gameId, playId)

plays_of_route_runners |> 
  inner_join(screen_plays) |> 
  filter(is.na(routeRan))
```


### Exploring the Philedelphia Eagles ----------------------- COME BACK AND PICK A TEAM AFTER EDA
```{r}

# all plays where Philadelphia eagles - there are 1,279 wr play information rows
phi_WR_plays <- plays_of_route_runners |> 
  filter(possessionTeam == "PHI")

phi_WR_plays


# In 598 of the plays with information for WR, the WR did not run a route
phi_WR_plays |> 
  filter(is.na(routeRan)) 
  
# All 598 of the plays where the receiver did not run a route did not have a pass thrown
phi_WR_plays |> 
  filter(is.na(routeRan),
         is.na(passLength)) 
  
# The number of WR involved in each non pass play and how many times that number of WR were involved
phi_WR_plays |> 
  filter(is.na(passLength)) |> 
  count(gameId, playId) |> 
  count(n) |> 
  rename(num_players = n,
         num_occurences = nn)

# The number of players who did not run a route on a play and how many times that many players didn't run a route
phi_WR_plays |> 
  filter(is.na(routeRan)) |> 
  count(gameId, playId) |> 
  count(n) |> 
  rename(num_players = n,
         num_occurences = nn)
  
plays_w_one <- phi_WR_plays |> 
  filter(is.na(passLength)) |> 
  count(gameId, playId) |> 
  filter(n == 1)

phi_WR_plays 

```


```{r}
# Filters the plays dataset to only include plays where no route was ran 
figure_out_nas <- plays |> 
  inner_join(no_route_ran) 

view(figure_out_nas)

# 
figure_out_nas |> 
  count(passLength) |> 
  arrange(passLength)

plays_of_route_runners |> 
  filter(is.na(passLength),
         str_detect(playDescription, "sacked")) |> 
  count(gameId, playId) |> 
  count(n)

# Number of occurences for each number of players that did not run a route, excluding pass plays  
plays_of_route_runners |>
  filter(!is.na(routeRan),
         qbSneak == TRUE)


plays_of_route_runners <- plays_of_route_runners |> 
  filter(qbSneak == FALSE)

plays_of_route_runners

|> 
  #filter(is.na(routeRan))
         
    
  
  
  
  filter(is.na(passLength), # most likely some sort of run play
         is.na(routeRan))|>  # plays where no route was run
  count(gameId, playId) |>  # the number of players that did not run a route on that play
  count(n) |> # the number of plays where that many players didn't run a route
  rename(num_players_no_route = n,
         times_occurred = nn)
  
# the number of players who did not run a route on each play - including pass plays
num_no_route_ran <- plays_of_route_runners |> 
  filter(is.na(routeRan)) |> 
  group_by(gameId, playId) |> 
  summarise(players_no_route = n()) |> 
  ungroup() |> 
  count(players_no_route) # notice that all players with 4 or 5 players not running a route are run plays. Otherwise mostly pass plays. When 2 players didn't run the route thats pretty split

num_no_route_ran
  
```


# Multi-Logistic Regression To Classify Which Route A Reciever Will Run

```{r}

```

