---
title: "Route Prediction"
author: "Belle Schmidt"
date: "2024-11-19"
output: html_document
---

# Set Up ---------------------

```{r}
# reading in the packages necessary
library(nflverse)
library(nflreadr)
library(nflplotR)
library(ggplot2)
library(tidyverse)
library(gganimate)
library(dplyr)
library(gganimate)
library(ggfootball)
```

```{r}
# gives me more information about the nflreadr package
library(help = "nflreadr")
```

```{r}
# reading in dataset
games <- read.csv("games.csv")
player_play <- read.csv("player_play.csv")
players <- read.csv("players.csv")
plays <- read.csv("plays.csv")
```

```{r}
# reading in week by week tracking data
tracking_week1 <- read.csv("tracking_week_1.csv")
tracking_week2 <- read.csv("tracking_week_2.csv")
tracking_week3 <- read.csv("tracking_week_3.csv")
tracking_week4 <- read.csv("tracking_week_4.csv")
tracking_week5 <- read.csv("tracking_week_5.csv")
tracking_week6 <- read.csv("tracking_week_6.csv")
tracking_week7 <- read.csv("tracking_week_7.csv")
tracking_week8 <- read.csv("tracking_week_9.csv")
```

# Determining What Plays To Include in Route Running Predicition ------------------

# Setting up the data for more exploration
```{r}
# add play information to individual player play by play data
player_play_w_info <- player_play |> 
  inner_join(plays, join_by(gameId, playId))

# identify all players (by nflID) that play WR 
WR <- players |> 
  filter(position == "WR") |> 
  distinct(nflId)
```

# Finding out which positions other than WR & TE are running routes 
```{r}
# identify all players that ran at least one route 
route_runners <- player_play |> 
  drop_na(routeRan) |> 
  distinct(nflId)

# identify which players were not WR that ran a route 
Non_WR_route_runners <- anti_join(route_runners, WR)
  
# identify which positions ran routes that were not WR and how often - notice there are QB, FB, TE, and RB as well
left_join(Non_WR_route_runners, players) |> 
  count(position)

# find out how many players play each position
players |> 
  count(position)
```

# Decided to focus on only WR 
```{r}
# Players WR Positions - Include only position of each player, their name, and their NFLId
positions <- players |> 
  filter(position == "WR") |> 
  select(nflId, displayName, position)

# All play information of WRs that ran at least one route - there are 40,940
plays_of_route_runners <- inner_join(player_play_w_info, positions)
```

# Finding the distribution of the routes ran - it is a little worrisome that so many routes are NAs. There is also a very large disproportion each route is run
```{r}
# The number of times and the proportion of the time each route is run by WR or TEs 
plays_of_route_runners |> 
  group_by(routeRan) |> 
  summarise(occurances = n()) |> 
  mutate(prop = occurances / sum(occurances)) 
```

# Figuring out what some of the NAs could mean -------------------
```{r}
# Plays where at least one receiver or tight end did not run a route - there are 6,874 plays
no_route_ran <- plays_of_route_runners |> 
  filter(is.na(routeRan)) |> 
  distinct(gameId, playId)

no_route_ran
```

```{r}
# Plays where the ball is spiked or the QB kneels - there are 188
deadplays <- plays |> 
  filter(is.na(offenseFormation))

deadplays
```

```{r}
# removes kneeling and spike plays - now there are 6,690 plays
no_route_ran <- anti_join(no_route_ran, deadplays)

no_route_ran

# removes kneeling and spike plays from WR play by play info - there are now 40,690 observations

plays_of_route_runners <- anti_join(plays_of_route_runners, deadplays, join_by(gameId, playId))

plays_of_route_runners

# remove QB sneaks from the data. This is okay to remove because QB sneaks are very predictable plays so the defense already knows the receiver isn't running a route. - There are still 40,438 reciever plays
plays_of_route_runners <- plays_of_route_runners |> 
  filter(is.na(qbSneak) | qbSneak == FALSE)

# See how many plays now have NAs for routes ran - 15,393
plays_of_route_runners |> 
  filter(is.na(routeRan))

# There are no plays that were blown dead because of penalty
plays_of_route_runners |> 
  count(playNullifiedByPenalty)
```


### Starting From Here Need To Redue. Did not finish  -----------------------
```{r}
phi_plays_w_WR_no_route <- plays_of_route_runners |> 
  filter(possessionTeam == "PHI",
         is.na(routeRan)) |> 
  distinct(gameId, playId) 

         
#phi_WR_plays <- plays_of_route_runners |> 
 # filter(possessionTeam == "PHI")

#phi_WR_plays |> 
 # inner_join(phi_plays_w_WR_no_route)
  

,
         #is.na(passLength)) 
```


```{r}
# Filters the plays dataset to only include plays where no route was ran 
figure_out_nas <- plays |> 
  inner_join(no_route_ran) 

view(figure_out_nas)

# 
figure_out_nas |> 
  count(passLength) |> 
  arrange(passLength)

plays_of_route_runners |> 
  filter(is.na(passLength),
         str_detect(playDescription, "sacked")) |> 
  count(gameId, playId) |> 
  count(n)

# Number of occurences for each number of players that did not run a route, excluding pass plays  
plays_of_route_runners |>
  filter(!is.na(routeRan),
         qbSneak == TRUE)


plays_of_route_runners <- plays_of_route_runners |> 
  filter(qbSneak == FALSE)

plays_of_route_runners

|> 
  #filter(is.na(routeRan))
         
    
  
  
  
  filter(is.na(passLength), # most likely some sort of run play
         is.na(routeRan))|>  # plays where no route was run
  count(gameId, playId) |>  # the number of players that did not run a route on that play
  count(n) |> # the number of plays where that many players didn't run a route
  rename(num_players_no_route = n,
         times_occurred = nn)
  
# the number of players who did not run a route on each play - including pass plays
num_no_route_ran <- plays_of_route_runners |> 
  filter(is.na(routeRan)) |> 
  group_by(gameId, playId) |> 
  summarise(players_no_route = n()) |> 
  ungroup() |> 
  count(players_no_route) # notice that all players with 4 or 5 players not running a route are run plays. Otherwise mostly pass plays. When 2 players didn't run the route thats pretty split

num_no_route_ran
  
```


# Multi-Logistic Regression To Classify Which Route A Reciever Will Run

```{r}

```

